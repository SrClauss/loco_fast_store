<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entrar — Painel de Envios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/output.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">

<div class="w-full max-w-md" x-data="painelLogin()">

  <!-- Logo -->
  <div class="text-center mb-8">
    <div class="inline-flex items-center justify-center w-14 h-14 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-2xl mb-4 shadow-lg">
      <i class="fas fa-truck text-white text-2xl"></i>
    </div>
    <h1 class="text-2xl font-bold text-gray-900">Painel de Envios</h1>
    <p class="text-gray-500 mt-1 text-sm">Gestão de pedidos e logística</p>
  </div>

  <!-- Card de login -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">

    <!-- Erro geral -->
    <div x-show="error" x-transition
         class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-sm text-red-700">
      <i class="fas fa-exclamation-circle flex-shrink-0"></i>
      <span x-text="error"></span>
    </div>

    <!-- Formulário -->
    <form @submit.prevent="submit" class="space-y-5">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
        <input
          type="email"
          x-model="form.email"
          required
          autofocus
          class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          placeholder="colaborador@exemplo.com"
        >
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
        <div class="relative">
          <input
            :type="showPw ? 'text' : 'password'"
            x-model="form.password"
            required
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent pr-10"
            placeholder="••••••••"
          >
          <button type="button" @click="showPw = !showPw"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
            <i x-show="!showPw" class="fas fa-eye"></i>
            <i x-show="showPw" x-cloak class="fas fa-eye-slash"></i>
          </button>
        </div>
      </div>

      <button
        type="submit"
        :disabled="loading"
        class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white font-semibold py-2.5 rounded-lg transition-colors text-sm"
      >
        <span x-show="!loading">Entrar</span>
        <span x-show="loading" x-cloak>
          <i class="fas fa-spinner fa-spin mr-2"></i>Entrando…
        </span>
      </button>
    </form>

    <!-- Seleção de loja (após login bem-sucedido) -->
    <div x-show="stores.length > 0" x-cloak x-transition class="mt-6 pt-6 border-t border-gray-100">
      <p class="text-sm font-medium text-gray-700 mb-3">Selecione a loja:</p>
      <div class="space-y-2">
        <template x-for="store in stores" :key="store.pid">
          <button
            @click="selectStore(store)"
            class="w-full flex items-center gap-3 px-4 py-3 border border-gray-200 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 transition-colors text-left"
          >
            <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-lg flex items-center justify-center text-white text-sm font-bold">
              <span x-text="store.name.charAt(0).toUpperCase()"></span>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900" x-text="store.name"></p>
              <p class="text-xs text-gray-500 capitalize" x-text="store.role"></p>
            </div>
            <i class="fas fa-chevron-right ml-auto text-gray-400"></i>
          </button>
        </template>
      </div>
    </div>
  </div>

  <p class="text-center text-xs text-gray-400 mt-6">
    Apenas colaboradores autorizados podem acessar este painel.
  </p>
</div>

<script>
function painelLogin() {
  return {
    form: { email: '', password: '' },
    stores: [],
    token: '',
    loading: false,
    showPw: false,
    error: '',

    async submit() {
      this.error = '';
      this.loading = true;
      try {
        const data = await fetch('/api/painel/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.form),
        }).then(r => r.json());

        if (!data.ok) throw data.error || { message: 'Credenciais inválidas' };

        this.token = data.data.token;
        this.stores = data.data.stores;

        if (this.stores.length === 0) {
          this.error = 'Você não tem acesso a nenhuma loja. Contate o administrador.';
        } else if (this.stores.length === 1) {
          this.selectStore(this.stores[0]);
        }
        // Se > 1 loja, exibe seleção
      } catch (e) {
        this.error = e.message || 'Erro ao fazer login';
      } finally {
        this.loading = false;
      }
    },

    selectStore(store) {
      localStorage.setItem('painel_token_' + store.pid, this.token);
      window.location.href = '/painel/' + store.pid + '/';
    },
  };
}
</script>
</body>
</html>
