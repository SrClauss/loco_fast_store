{% extends "painel/layouts/base.html" %}
{% block title %}Pedidos{% endblock %}
{% block page_title %}Pedidos{% endblock %}
{% set current_page = "orders" %}

{% block content %}
<div x-data="painelOrderList()" x-init="init()">

  <!-- Filtros -->
  <div class="bg-white rounded-xl border border-gray-200 p-4 mb-4 flex flex-wrap items-center gap-3">

    <div class="relative flex-1 min-w-48">
      <input
        type="text"
        x-model="search"
        @input.debounce.400ms="fetchOrders(true)"
        placeholder="Número do pedido…"
        class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
      >
      <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
    </div>

    <select x-model="filters.status" @change="fetchOrders(true)"
            class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
      <option value="">Todos os status</option>
      <option value="pending">Pendente</option>
      <option value="confirmed">Confirmado</option>
      <option value="processing">Processando</option>
      <option value="cancelled">Cancelado</option>
    </select>

    <select x-model="filters.fulfillment_status" @change="fetchOrders(true)"
            class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
      <option value="">Todos os envios</option>
      <option value="not_fulfilled">Aguardando envio</option>
      <option value="fulfilled">Enviado</option>
      <option value="delivered">Entregue</option>
    </select>

    <button @click="fetchOrders(true)" aria-label="Atualizar lista de pedidos" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg transition-colors">
      <i class="fas fa-sync mr-1.5"></i>Atualizar
    </button>
  </div>

  <!-- Tabela -->
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">

    <!-- Loading -->
    <div x-show="loading && orders.length === 0" class="p-12 text-center text-gray-400">
      <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
      <p>Carregando pedidos…</p>
    </div>

    <!-- Vazio -->
    <div x-show="!loading && orders.length === 0" class="p-12 text-center text-gray-400">
      <i class="fas fa-inbox text-4xl mb-3"></i>
      <p class="font-medium">Nenhum pedido encontrado</p>
      <p class="text-sm mt-1">Tente ajustar os filtros.</p>
    </div>

    <!-- Lista -->
    <div x-show="orders.length > 0" class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-gray-50 text-xs font-semibold text-gray-500 uppercase tracking-wider">
          <tr>
            <th class="px-6 py-3 text-left">Pedido</th>
            <th class="px-6 py-3 text-left">Data</th>
            <th class="px-6 py-3 text-left">Status</th>
            <th class="px-6 py-3 text-left">Pagamento</th>
            <th class="px-6 py-3 text-left">Envio</th>
            <th class="px-6 py-3 text-left">Rastreio</th>
            <th class="px-6 py-3 text-right">Total</th>
            <th class="px-6 py-3 text-center">Ação</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <template x-for="order in orders" :key="order.pid">
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="px-6 py-4">
                <span class="font-mono font-semibold text-gray-900" x-text="order.order_number"></span>
              </td>
              <td class="px-6 py-4 text-gray-500 text-xs" x-text="fmtDate(order.created_at)"></td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                      :class="statusClass(order.status)" x-text="statusLabel(order.status)"></span>
              </td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                      :class="statusClass(order.payment_status)" x-text="statusLabel(order.payment_status)"></span>
              </td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                      :class="statusClass(order.fulfillment_status)" x-text="statusLabel(order.fulfillment_status)"></span>
              </td>
              <td class="px-6 py-4">
                <template x-if="order.shipping?.tracking_code">
                  <a :href="order.shipping.tracking_url || '#'" target="_blank"
                     class="text-indigo-600 hover:text-indigo-800 font-mono text-xs"
                     x-text="order.shipping.tracking_code"></a>
                </template>
                <span x-show="!order.shipping?.tracking_code" class="text-gray-400 text-xs">—</span>
              </td>
              <td class="px-6 py-4 text-right font-semibold text-gray-900" x-text="fmt(order.total)"></td>
              <td class="px-6 py-4 text-center">
                <a :href="'/painel/{{ store.pid }}/pedidos/' + order.pid"
                   class="inline-flex items-center gap-1 px-3 py-1.5 border border-indigo-300 text-indigo-700 hover:bg-indigo-50 text-xs font-medium rounded-lg transition-colors">
                  <i class="fas fa-eye"></i> Detalhes
                </a>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Paginação -->
    <div x-show="hasMore" class="px-6 py-4 border-t border-gray-100 text-center">
      <button @click="fetchOrders(false)" :disabled="loading"
              class="px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 disabled:opacity-50 transition-colors">
        <span x-show="!loading">Carregar mais</span>
        <span x-show="loading"><i class="fas fa-spinner fa-spin mr-1"></i>Carregando…</span>
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function painelOrderList() {
  return {
    orders: [],
    loading: false,
    hasMore: false,
    cursor: null,
    search: '',
    filters: {
      status: new URLSearchParams(location.search).get('status') || '',
      fulfillment_status: new URLSearchParams(location.search).get('fulfillment_status') || '',
    },

    async init() {
      await this.fetchOrders(true);
    },

    async fetchOrders(reset = true) {
      if (reset) { this.orders = []; this.cursor = null; }
      this.loading = true;
      try {
        const params = new URLSearchParams({ limit: 25 });
        if (this.filters.status) params.set('status', this.filters.status);
        if (this.filters.fulfillment_status) params.set('fulfillment_status', this.filters.fulfillment_status);
        if (this.cursor) params.set('cursor', this.cursor);

        const res = await fetch(`/api/painel/{{ store.pid }}/pedidos?${params}`, {
          headers: papi.headers()
        }).then(r => r.json());

        if (!res.ok) throw res.error;
        const newOrders = res.data ?? [];
        this.orders = reset ? newOrders : [...this.orders, ...newOrders];
        this.hasMore = res.meta?.has_more ?? false;
        this.cursor = res.meta?.cursor ?? null;
      } catch (e) {
        console.error('Erro ao carregar pedidos:', e);
      } finally {
        this.loading = false;
      }
    },
  };
}
</script>
{% endblock %}
