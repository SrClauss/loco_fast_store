{% extends "admin/layouts/base.html" %}

{% block title %}Categorias{% endblock %}
{% block page_title %}Categorias{% endblock %}

{% block content %}
<div x-data="categoriesData()" x-init="init()">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div class="relative">
      <input 
        type="text" 
        x-model="search"
        @input.debounce.300ms="fetchCategories()"
        placeholder="Buscar categorias..."
        class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent w-80"
      >
      <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
    </div>

    <button @click="openModal()" class="btn-primary">
      <i class="fas fa-plus mr-2"></i>
      Nova Categoria
    </button>
  </div>

  <!-- Categories grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <template x-if="loading">
      <template x-for="i in 6" :key="i">
        <div class="card">
          <div class="card-body">
            <div class="skeleton h-40 w-full"></div>
          </div>
        </div>
      </template>
    </template>

    <template x-for="category in categories" :key="category.id">
      <div class="card hover:shadow-md transition-shadow">
        <div x-show="category.image" class="h-48 overflow-hidden">
          <img :src="category.image" :alt="category.name" class="w-full h-full object-cover">
        </div>
        <div class="card-body">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900 mb-1" x-text="category.name"></h3>
              <p class="text-sm text-gray-500 line-clamp-2" x-text="category.description || 'Sem descrição'"></p>
            </div>
            <span 
              class="badge ml-2"
              :class="category.status === 'active' ? 'badge-success' : 'badge-warning'"
              x-text="category.statusLabel"
            ></span>
          </div>

          <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
            <div class="flex items-center gap-1">
              <i class="fas fa-box"></i>
              <span x-text="category.productCount + ' produtos'"></span>
            </div>
            <span x-text="formatDate(category.createdAt)"></span>
          </div>

          <div class="flex items-center gap-2">
            <button 
              @click="editCategory(category)"
              class="flex-1 btn-secondary btn-sm"
            >
              Editar
            </button>
            <button 
              @click="deleteCategory(category.id)"
              class="btn-ghost btn-sm text-red-600 hover:bg-red-50"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- Empty state -->
  <template x-if="!loading && categories.length === 0">
    <div class="card">
      <div class="card-body text-center py-12">
        <i class="fas fa-tags text-gray-300 text-6xl mx-auto mb-4"></i>
        <p class="text-gray-500 mb-4">Nenhuma categoria encontrada</p>
        <button @click="openModal()" class="btn-primary">Criar primeira categoria</button>
      </div>
    </div>
  </template>

  <!-- Modal -->
  <div 
    x-show="modalOpen"
    x-cloak
    class="fixed inset-0 z-50 overflow-y-auto"
    @keydown.escape.window="closeModal()"
  >
    <div class="flex items-center justify-center min-h-screen px-4">
      <div 
        x-show="modalOpen"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        @click="closeModal()"
        class="fixed inset-0 bg-black bg-opacity-50"
      ></div>

      <div 
        x-show="modalOpen"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        class="relative bg-white rounded-lg shadow-xl max-w-md w-full"
        @click.stop
      >
        <form @submit.prevent="submit()">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900" x-text="form.id ? 'Editar Categoria' : 'Nova Categoria'"></h3>
          </div>

          <div class="px-6 py-4 space-y-4">
            <div>
              <label class="form-label">Nome *</label>
              <input 
                type="text" 
                x-model="form.name"
                @input="generateSlug()"
                class="form-input"
                placeholder="Nome da categoria"
                required
              >
            </div>

            <div>
              <label class="form-label">Slug *</label>
              <input 
                type="text" 
                x-model="form.slug"
                class="form-input font-mono text-sm"
                placeholder="slug-da-categoria"
                required
              >
            </div>

            <div>
              <label class="form-label">Descrição</label>
              <textarea 
                x-model="form.description"
                rows="3"
                class="form-input"
                placeholder="Descrição da categoria"
              ></textarea>
            </div>

            <div>
              <label class="form-label">Status</label>
              <select x-model="form.status" class="form-input">
                <option value="active">Ativa</option>
                <option value="inactive">Inativa</option>
              </select>
            </div>

            <div>
              <label class="form-label">Categoria Pai</label>
              <select x-model="form.parentId" class="form-input">
                <option value="">Nenhuma (Categoria raiz)</option>
                <template x-for="cat in categories.filter(c => c.id !== form.id)" :key="cat.id">
                  <option :value="cat.id" x-text="cat.name"></option>
                </template>
              </select>
            </div>
          </div>

          <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-end gap-3">
            <button type="button" @click="closeModal()" class="btn-ghost">Cancelar</button>
            <button 
              type="submit"
              :disabled="saving"
              :class="saving ? 'opacity-50 cursor-not-allowed' : ''"
              class="btn-primary"
            >
              <span x-show="!saving" x-text="form.id ? 'Atualizar' : 'Criar'"></span>
              <span x-show="saving" x-cloak>Salvando...</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function categoriesData() {
  return {
    categories: [],
    loading: true,
    search: '',
    modalOpen: false,
    saving: false,
    form: {
      id: null,
      name: '',
      slug: '',
      description: '',
      status: 'active',
      parentId: ''
    },

    async init() {
      await this.fetchCategories();
    },

    async fetchCategories() {
      this.loading = true;
      try {
        const params = new URLSearchParams({ search: this.search });
        const data = await api.get(`/categories?${params}`);
        this.categories = data.data || [];
      } catch (error) {
        toast.error('Erro ao carregar categorias');
      } finally {
        this.loading = false;
      }
    },

    openModal() {
      this.form = {
        id: null,
        name: '',
        slug: '',
        description: '',
        status: 'active',
        parentId: ''
      };
      this.modalOpen = true;
    },

    closeModal() {
      this.modalOpen = false;
    },

    editCategory(category) {
      this.form = {
        id: category.id,
        name: category.name,
        slug: category.slug,
        description: category.description || '',
        status: category.status,
        parentId: category.parentId || ''
      };
      this.modalOpen = true;
    },

    generateSlug() {
      if (!this.form.id) {
        this.form.slug = this.form.name
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      }
    },

    async submit() {
      this.saving = true;
      try {
        if (this.form.id) {
          await api.put(`/categories/${this.form.id}`, this.form);
          toast.success('Categoria atualizada com sucesso!');
        } else {
          await api.post('/categories', this.form);
          toast.success('Categoria criada com sucesso!');
        }
        
        this.closeModal();
        await this.fetchCategories();
      } catch (error) {
        toast.error(error.message || 'Erro ao salvar categoria');
      } finally {
        this.saving = false;
      }
    },

    async deleteCategory(id) {
      if (!confirm('Tem certeza que deseja excluir esta categoria? Esta ação não pode ser desfeita.')) {
        return;
      }

      try {
        await api.delete(`/categories/${id}`);
        toast.success('Categoria excluída com sucesso!');
        await this.fetchCategories();
      } catch (error) {
        toast.error('Erro ao excluir categoria');
      }
    }
  }
}
</script>
{% endblock %}
