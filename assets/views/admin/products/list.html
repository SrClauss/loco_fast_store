{% extends "admin/layouts/base.html" %}

{% block title %}Produtos{% endblock %}
{% block page_title %}Produtos{% endblock %}

{% block content %}
<div x-data="productsListData()" x-init="init()">
  <!-- Header actions -->
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <div class="relative">
        <input 
          type="text" 
          x-model="filters.search"
          @input.debounce.300ms="fetchProducts()"
          placeholder="Buscar produtos..."
          class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent w-80"
        >
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
      </div>

      <select x-model="filters.status" @change="fetchProducts()" class="border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
        <option value="">Todos os status</option>
        <option value="active">Ativos</option>
        <option value="draft">Rascunho</option>
        <option value="archived">Arquivados</option>
      </select>

      <select x-model="filters.category" @change="fetchProducts()" class="border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
        <option value="">Todas categorias</option>
        <template x-for="category in categories" :key="category.id">
          <option :value="category.id" x-text="category.name"></option>
        </template>
      </select>
    </div>

    <div class="flex items-center gap-3">
      <button @click="exportProducts()" class="btn-secondary">
        <i class="fas fa-download mr-2"></i>
        Exportar
      </button>
      <a href="/admin/products/new" class="btn-primary">
        <i class="fas fa-plus mr-2"></i>
        Novo Produto
      </a>
    </div>
  </div>

  <!-- Products table -->
  <div class="card">
    <div class="overflow-x-auto">
      <table class="table">
        <thead class="bg-gray-50">
          <tr>
            <th class="table-header w-12">
              <input 
                type="checkbox" 
                @change="toggleSelectAll($event)"
                class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500"
              >
            </th>
            <th class="table-header">Produto</th>
            <th class="table-header">Status</th>
            <th class="table-header">Inventário</th>
            <th class="table-header">Categoria</th>
            <th class="table-header">Preço</th>
            <th class="table-header">Criado em</th>
            <th class="table-header w-24"></th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <template x-if="loading">
            <template x-for="i in 5" :key="i">
              <tr>
                <td class="table-cell" colspan="8">
                  <div class="skeleton h-12 w-full"></div>
                </td>
              </tr>
            </template>
          </template>

          <template x-if="!loading && products.length === 0">
            <tr>
              <td class="table-cell text-center py-12" colspan="8">
                <i class="fas fa-box text-gray-300 text-6xl mx-auto mb-4"></i>
                <p class="text-gray-500">Nenhum produto encontrado</p>
                <a href="/admin/products/new" class="btn-primary mt-4 inline-flex">Criar primeiro produto</a>
              </td>
            </tr>
          </template>

          <template x-for="product in products" :key="product.id">
            <tr class="hover:bg-gray-50">
              <td class="table-cell">
                <input 
                  type="checkbox" 
                  :checked="selectedIds.includes(product.id)"
                  @change="toggleSelect(product.id)"
                  class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500"
                >
              </td>
              <td class="table-cell">
                <div class="flex items-center gap-3">
                  <img 
                    :src="product.image || '/static/images/placeholder.png'" 
                    :alt="product.name"
                    class="w-12 h-12 rounded-lg object-cover"
                  >
                  <div>
                    <a :href="'/admin/products/' + product.id" class="font-medium text-gray-900 hover:text-pink-600" x-text="product.name"></a>
                    <p class="text-sm text-gray-500" x-text="product.sku"></p>
                  </div>
                </div>
              </td>
              <td class="table-cell">
                <span 
                  class="badge"
                  :class="{
                    'badge-success': product.status === 'active',
                    'badge-warning': product.status === 'draft',
                    'badge-error': product.status === 'archived'
                  }"
                  x-text="product.statusLabel"
                ></span>
              </td>
              <td class="table-cell">
                <span x-text="product.stock"></span>
                <span 
                  x-show="product.stock <= product.lowStockThreshold"
                  class="ml-2 text-xs text-red-600"
                >
                  Estoque baixo
                </span>
              </td>
              <td class="table-cell">
                <span x-text="product.categoryName"></span>
              </td>
              <td class="table-cell">
                <span class="font-medium" x-text="formatCurrency(product.price)"></span>
              </td>
              <td class="table-cell">
                <span x-text="formatDate(product.createdAt)"></span>
              </td>
              <td class="table-cell">
                <div class="flex items-center gap-2">
                  <a :href="'/admin/products/' + product.id + '/edit'" class="p-1 text-gray-400 hover:text-pink-600">
                    <i class="fas fa-edit"></i>
                  </a>
                  <button @click="deleteProduct(product.id)" class="p-1 text-gray-400 hover:text-red-600">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
      <div class="text-sm text-gray-700">
        Mostrando <span class="font-medium" x-text="pagination.from"></span> até 
        <span class="font-medium" x-text="pagination.to"></span> de 
        <span class="font-medium" x-text="pagination.total"></span> produtos
      </div>
      <div class="flex gap-2">
        <button 
          @click="previousPage()"
          :disabled="pagination.current === 1"
          :class="pagination.current === 1 ? 'opacity-50 cursor-not-allowed' : ''"
          class="btn-secondary btn-sm"
        >
          Anterior
        </button>
        <template x-for="page in paginationPages" :key="page">
          <button 
            @click="goToPage(page)"
            :class="page === pagination.current ? 'btn-primary btn-sm' : 'btn-secondary btn-sm'"
            x-text="page"
          ></button>
        </template>
        <button 
          @click="nextPage()"
          :disabled="pagination.current === pagination.last"
          :class="pagination.current === pagination.last ? 'opacity-50 cursor-not-allowed' : ''"
          class="btn-secondary btn-sm"
        >
          Próxima
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk actions bar -->
  <div 
    x-show="selectedIds.length > 0"
    x-transition
    class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white rounded-lg shadow-lg border border-gray-200 px-6 py-3 flex items-center gap-4"
  >
    <span class="text-sm font-medium text-gray-700">
      <span x-text="selectedIds.length"></span> produtos selecionados
    </span>
    <div class="h-6 w-px bg-gray-300"></div>
    <button @click="bulkAction('activate')" class="text-sm text-green-600 hover:text-green-700 font-medium">Ativar</button>
    <button @click="bulkAction('draft')" class="text-sm text-yellow-600 hover:text-yellow-700 font-medium">Rascunho</button>
    <button @click="bulkAction('archive')" class="text-sm text-gray-600 hover:text-gray-700 font-medium">Arquivar</button>
    <button @click="bulkAction('delete')" class="text-sm text-red-600 hover:text-red-700 font-medium">Excluir</button>
    <button @click="selectedIds = []" class="text-sm text-gray-500 hover:text-gray-700 ml-2">Cancelar</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function productsListData() {
  return {
    products: [],
    categories: [],
    loading: true,
    selectedIds: [],
    filters: {
      search: '',
      status: '',
      category: ''
    },
    pagination: {
      current: 1,
      last: 1,
      from: 0,
      to: 0,
      total: 0,
      perPage: 15
    },

    async init() {
      await this.fetchCategories();
      await this.fetchProducts();
    },

    async fetchProducts() {
      this.loading = true;
      try {
        const params = new URLSearchParams({
          page: this.pagination.current,
          per_page: this.pagination.perPage,
          ...this.filters
        });

        const data = await api.get(`/products?${params}`);
        this.products = data.data || [];
        this.pagination = {
          current: data.current_page,
          last: data.last_page,
          from: data.from,
          to: data.to,
          total: data.total,
          perPage: data.per_page
        };
      } catch (error) {
        toast.error('Erro ao carregar produtos');
      } finally {
        this.loading = false;
      }
    },

    async fetchCategories() {
      try {
        const data = await api.get('/categories');
        this.categories = data.data || [];
      } catch (error) {
        console.error('Error fetching categories:', error);
      }
    },

    async deleteProduct(id) {
      if (!confirm('Tem certeza que deseja excluir este produto?')) return;

      try {
        await api.delete(`/products/${id}`);
        toast.success('Produto excluído com sucesso');
        await this.fetchProducts();
      } catch (error) {
        toast.error('Erro ao excluir produto');
      }
    },

    async bulkAction(action) {
      if (this.selectedIds.length === 0) return;

      try {
        await api.post('/products/bulk-action', {
          action,
          ids: this.selectedIds
        });
        
        toast.success('Ação realizada com sucesso');
        this.selectedIds = [];
        await this.fetchProducts();
      } catch (error) {
        toast.error('Erro ao executar ação');
      }
    },

    toggleSelect(id) {
      const index = this.selectedIds.indexOf(id);
      if (index === -1) {
        this.selectedIds.push(id);
      } else {
        this.selectedIds.splice(index, 1);
      }
    },

    toggleSelectAll(event) {
      if (event.target.checked) {
        this.selectedIds = this.products.map(p => p.id);
      } else {
        this.selectedIds = [];
      }
    },

    goToPage(page) {
      this.pagination.current = page;
      this.fetchProducts();
    },

    previousPage() {
      if (this.pagination.current > 1) {
        this.pagination.current--;
        this.fetchProducts();
      }
    },

    nextPage() {
      if (this.pagination.current < this.pagination.last) {
        this.pagination.current++;
        this.fetchProducts();
      }
    },

    get paginationPages() {
      const pages = [];
      const maxPages = 5;
      let start = Math.max(1, this.pagination.current - Math.floor(maxPages / 2));
      let end = Math.min(this.pagination.last, start + maxPages - 1);
      
      if (end - start < maxPages - 1) {
        start = Math.max(1, end - maxPages + 1);
      }
      
      for (let i = start; i <= end; i++) {
        pages.push(i);
      }
      
      return pages;
    },

    exportProducts() {
      window.location.href = '/api/products/export?' + new URLSearchParams(this.filters);
    }
  }
}
</script>
{% endblock %}
